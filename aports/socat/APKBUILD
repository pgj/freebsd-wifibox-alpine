# Maintainer: Gabor Pali <pali.gabor@gmail.com>

pkgname=socat
pkgver=1.8.0.3
pkgrel=0 # base: 1
pkgdesc="Multipurpose relay for binary protocols (stripped)"
options="!check"
url="http://www.dest-unreach.org/socat/"
arch="all"
license="GPL-2.0-only WITH OpenSSL-Exception"
makedepends="linux-headers"
subpackages="$pkgname-with-udp:_udp"
source="http://www.dest-unreach.org/socat/download/socat-$pkgver.tar.gz
	use-linux-headers.patch
	netdb-internal.patch
	no-extras.patch
	"

_srcdir="$srcdir"/"$pkgname"-"$pkgver"
_stripped_build_dir="$srcdir"/build-stripped
_with_udp_build_dir="$srcdir"/build-with-udp

prepare() {
	default_prepare

	mkdir -p \
		"$_stripped_build_dir" \
		"$_with_udp_build_dir"
}

_options="--srcdir=$_srcdir
	--build=$CBUILD
	--host=$CHOST
	--disable-stdio
	--disable-fdnum
	--disable-file
	--disable-creat
	--disable-gopen
	--disable-pipe
	--disable-socketpair
	--disable-shell
	--disable-stats
	--disable-ip6
	--disable-rawip
	--disable-genericsocket
	--disable-interface
	--disable-sctp
	--disable-dccp
	--disable-vsock
	--disable-namespaces
	--disable-posixmq
	--disable-socks4
	--disable-socks4a
	--disable-socks5
	--disable-proxy
	--disable-exec
	--disable-system
	--disable-pty
	--disable-fs
	--disable-readline
	--disable-openssl
	--disable-tun
	--disable-sycls
	--disable-filan
	--disable-retry
	--disable-libwrap
	--prefix=/usr"

build() {
	msg "Building stripped (strict)"

	cd "$_stripped_build_dir"
	"$_srcdir"/configure \
		$_options \
		--disable-udp
	make -j8

	msg "Building with UDP"

	cd "$_with_udp_build_dir"
	"$_srcdir"/configure \
		$_options
	make -j8
}

package() {
	cd "$_stripped_build_dir"
	make DESTDIR="$pkgdir" install
}

_udp() {
	pkgdesc="Multipurpose relay for binary protocols (with UDP enabled)"
	provides="socat"
	mkdir -p "$subpkgdir"
	cd "$_with_udp_build_dir"
	make DESTDIR="$subpkgdir" install
}

sha512sums="
600a3387e9756e0937d2db49de9066df03d9818e4042da6b72109d1b5688dd72352754773a19bd2558fe93ec6a8a73e80e7cf2602fd915960f66c403fd89beef  socat-1.8.0.3.tar.gz
2032b6528cb27b69d8fb6a6f64af32fcc1f6e4934bb0d7c8931b38ab7ad5e27f6f4344a6cf49751fa3178cd725f954e195373362f7d5929e587d7f0309346059  use-linux-headers.patch
22a6e0c2317a9317997c98114daac258ebbcc3d8e58e49a6ebf24781b98967afed47c63807282582fa0909076fe349281f05e4462faacb90e7aabc853903d6e6  netdb-internal.patch
d61633757f751bf28114ecf25b0b1af49827e4c980d44cbb37e759be48b8a4387de516dc77a12da90c1893772e14a3548c01eea120afadddc3d06773eae7fd71  no-extras.patch
"
