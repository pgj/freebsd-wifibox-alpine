# Maintainer: Gabor Pali <pali.gabor@gmail.com>

pkgname=wpa_supplicant
pkgver=2.11
pkgrel=0 # base: 2
pkgdesc="utility providing key negotiation for WPA wireless networks"
url="https://w1.fi/wpa_supplicant/"
arch="all"
options="!check" # has no tests
license="BSD-3-Clause"
subpackages=
makedepends="linux-headers openssl-dev>3 dbus-dev libnl3-dev pcsc-lite-dev"
source="https://w1.fi/releases/wpa_supplicant-$pkgver.tar.gz
	wpa_supplicant.initd
	wpa_supplicant.confd

	0001-nl80211-add-extra-ies-only-if-allowed-by-driver.patch
	0002-AP-guard-FT-SAE-code-with-CONFIG_IEEE80211R_AP.patch
	wpa_supplicant-2.11-Revert-Mark-authorization-completed-on-driver-indica.patch

	no-tools.patch
	config
	"

# secfixes:
#   2.10-r11:
#     - CVE-:2023-52160
#   2.9-r13:
#     - CVE-2021-30004
#   2.9-r12:
#     - CVE-2021-27803
#   2.9-r10:
#     - CVE-2021-0326
#   2.9-r5:
#     - CVE-2019-16275
#   2.7-r3:
#     - CVE-2019-11555
#   2.7-r2:
#     - CVE-2019-9494
#     - CVE-2019-9495
#     - CVE-2019-9497
#     - CVE-2019-9498
#     - CVE-2019-9499
#   2.6-r14:
#     - CVE-2018-14526
#   2.6-r7:
#     - CVE-2017-13077
#     - CVE-2017-13078
#     - CVE-2017-13079
#     - CVE-2017-13080
#     - CVE-2017-13081
#     - CVE-2017-13082
#     - CVE-2017-13086
#     - CVE-2017-13087
#     - CVE-2017-13088

prepare() {
	default_prepare

	# Copy our configuration file to the build directory
	cp "$srcdir"/config "$builddir"/wpa_supplicant/.config
}

build() {
	export CFLAGS="$CFLAGS -flto=auto"
	cd "$builddir"/wpa_supplicant
	make LIBDIR=/lib BINDIR=/sbin
}

package() {
	cd "$builddir"/wpa_supplicant
	make DESTDIR="$pkgdir" LIBDIR=/lib BINDIR=/sbin install

	# openrc runscripts
	install -Dm755 "$srcdir"/wpa_supplicant.initd \
		"$pkgdir"/etc/init.d/wpa_supplicant
	install -Dm644 "$srcdir"/wpa_supplicant.confd \
		"$pkgdir"/etc/conf.d/wpa_supplicant
}

sha512sums="
9a0a3a9d6fa2235903c40aa57b5955f0c9dd1dccfd0e3825a3b6f92b3e32db8d464b3ea0aef3285ba3ee109e7b190560cedd744902e954f0003cdba543e277b2  wpa_supplicant-2.11.tar.gz
db0ae409f40c9a7397f5664b78d8b6917e194d35847b180e6de712175a3ea1556eebb6d76736f2d5856ad2354be3931dc0f06f9b8fea0b85390763a925506c99  wpa_supplicant.initd
175f1404b516121380b77a185e35de6e633663b1c87c2464a4d839db4c313d96851a45c46b514583f27c856d14589a94772ad275dbef1acd440bbe43b515e0d9  wpa_supplicant.confd
fb328872087268056b035802f71df2f7af8d11699822fe68611201a07dc693c4fdb8c50dd4fd509ed6db4cca89f6003ce3303770951686a35633977f466f4fb5  0001-nl80211-add-extra-ies-only-if-allowed-by-driver.patch
d70b2d98b1ffefb1c9023e693d02e1adf21ba21535f7fb76f69f30cb95fb9ab393561d59f27517874108088f0e9061ab88333f65e25d70fab760d4c0d8366dc4  0002-AP-guard-FT-SAE-code-with-CONFIG_IEEE80211R_AP.patch
5d54d6e5a06bb8d0612b2178a3c6ddf27b9bca142e3c512f67df0ace9e650ae343170ea05f47156717c717484c85e5b890706a92ad353046a8a61e8aae8dc1c2  wpa_supplicant-2.11-Revert-Mark-authorization-completed-on-driver-indica.patch
0acc0d5d05d295bfb3b9dc3e0e3c9b6d395b54aa1a39a2d56fd0b08dd864b1ce9cc0fd54d3c2ee52d06ed7007338024c7f6fd5c73ad2ed30a77446a05829a76f  no-tools.patch
3a807fbd76d8c49102d3952052cbefc91131da5fea2b71057dc586563215fc9a94d9497127897055db15eaf55b08445c8a6fdfff22ef76aae63b9688c12cb775  config
"
